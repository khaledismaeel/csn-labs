

# T4: Architecture and Design

_Khaled Ismaeel_
_Mihail Olokin_
_Ayomide Shoyemi_
_Rail Iaushev_

## Contents

[TOC]

## Introduction

This section offers the background necessary for understanding this document. First, we present the application under consideration, T4, in _Introduction_. Next, in _Scope_, we set the boundaries for what to be expected in this document. Finally, we conclude with _Contents_ where we draw the roadmap for the rest of the document.

### Application description

The application under consideration in this document is _T4_. T4 is an end-consumer mobile application for monitoring IoT devices. In particular, the application offers a user-friendly dashboard for viewing the user's IoT devices after they have been set up to be monitored by the application.

The application is mainly aimed at smart home owners who wish to keep track of their smart devices, from a distance, using a mobile phone. However, the application offers advanced setup options that make it useful for IoT specialists experimenting with any IP-aware IoT devices.

### Scope

This document includes:

- Requirement solicitaion results
- High level system architecture
- Mapping of the software components onto particular technologies
- A description of the intended deployment of the application

### Contents

Next, in _Requirements_, we list our product's requirements. After that we present the system architecture in _Architecture_. Then we list our choice of technology in _Technology stack_. In _Deployment_ we present the recommended deployment model of the application. Finally we finish off with concluding remarks in _Conclusion_

## Requirements

The software requirements presented are by no means exhaustive. They are a starting point set by T4 developers that is expected to be updated, expanded, and elaborated upon.

### Functional requirements

| Requirement ID | Requirement description |
| -------------- | ----------------------- |
| RF-1 | Upon application startup, the system shall list all user devices. |
| RF-2 | For each listed device, the system shall indicate whether the device is connected or disconnected from the app in real time. |
| RF-3 | Upon selecting a particlar device, the system shall expand the device view to provide further information: device metadata, metrics, advanced details. |
| RF-4 | Upon selecting the metrics tab, the system shall present the corresponding IoT device readings in an appropriate graph. |
| RF-5 | Upon selecting the advanced details tab, the system shall provide all information necessary to programmatically read metrics from the device. |

### Non-functional requirements

| Requirement ID | Requirement description |
| -------------- | ----------------------- |
| RN-1 | The system shall be reselient to malfunctioning devices. |
| RN-2 | The system shall minimize storage usage by compressing and rotating all readings. |
| RN-4 | The system shall use no more than 3% of available processing power in the foreground and no more than 0.1% on standby. |

## Architecture

This section presents the high level application architecture of T4. First we start by reviewing the static system architecture in _Structural components_. Then we present the interoperation of these components in _Data and control flow_.

### Structural components

T4 follows a simplified microservice architecture, depicted in the UML component diagram below.

![](https://i.imgur.com/h44WbSx.png)

The componenets are

- **Device adapters**. These are microservices that pull raw data from a family of sensors and formats them into a stream of discrete samples, the schema of which depends on the device and metric type.
- **Aggregator**. This is component collects the sample streams generated by the device adapters and aggregates their output into a device-independent format. It consists of the following.
    - **Storage driver** that offers a stable API for reading the generated time series data.
    - **Filtering module** that preprocesses sampled data from the device adapters.
    - **Rate limiter** that throttles the aggregator traffic depending on external constraints.
    - A storage-independent **Rotator** that maintains log bounds in a lazy manner.
- **Time series database**. This optional component can be configured to synchronize with the aggregator readings to persist data outside the application address space.
- **Load balancer**. This component acts as the gateway to the aggregator in case more then one client application are assigned to the same aggregator.
- **Application client**. A REST-aware application that takes time series data and parses them into user-oriented graphics.
- **User interface**. A web page for presenting the data to the end user.

### Data and control flow

The table below lists all communication channels in T4. 

| Channel | Type |
| ------- | ---- |
| device $\leftrightarrow$ device adapter | control + data |
| device adapter $\leftrightarrow$ aggregator | control + data |
| aggregator $\leftrightarrow$ time series database | data |
| aggregator $\leftrightarrow$ application client| control + data |
| application client $\leftrightarrow$ time series database | control + data |

Below we have a UML sequence diagram of the complete data flow pipeline starting from the end user. These diagrams are not exhaustive, they are merely presented for understanding.


User opens the application:

![](https://i.imgur.com/fYwCW4f.png)


User opens filters the displayed data:

![](https://i.imgur.com/5R8mz2r.png)


User decides to look at how the data changed over some period of time:

![](https://i.imgur.com/zGB3pFs.png)


## Technology stack

This section lists the technologies used for implementing the architecture. It follows an identical layout to the previous section; in _Components_ we present technologies used for implementing structural components. While in _Control and data flow_ we present the networking protocols used in the channels.

### Components



| Component | Written in | Using frameworks |
| -------- | -------- | -------- |
| Device adapters | vendor-specific | vendor-specific |
| Aggregator | Rust | - |
| Time series database | - | PostgreSQL |
| Load balancer | - | Nginx |
| Application client | Python | Flask |
| User interface | Javascript | Svelte + Tailwind CSS |


### Data and control flow

| Channel | Protocol |
| ------- | ---- |
| device $\leftrightarrow$ device adapter | vendor-specific |
| device adapter $\leftrightarrow$ aggregator | HTTPS (HTTP not accepted) |
| aggregator $\leftrightarrow$ time series database | PostgreSQL |
| aggregator $\leftrightarrow$ application client| HTTPS |
| application client $\leftrightarrow$ time series database | PostgreSQL |

## Deployment

As the application architecture specified above is a microservice one, all components will be wrapped in Docker containers for the sake of maintainability. However, at the current stage of development, the application is only meant to be deployed on single mobile phones devices. The possibility of cloud-deploying the application will be investigated by the design team at a later stage.

With that in mind, the application will be parsed as a Helm chart and installed on client devices using microk8s as a single mobile application. Support for arbitrary Kubernetes cluster deployment will not be considered by the developers at this stage of development.

## Conclusion

In this document we have presented the software architecture of T4, a personal mobile IoT device monitor for smart homes. We presented a high level view of the microservice system architecture. We also mapped the components and their communication channels onto a specific technology stack. We finally presented the intended deployment scheme of the application.

